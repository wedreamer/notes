# 第二十一章 主从复制

Redis支持主从复制功能，用户可以通过执行slaveof命令或者在配置文件中设置slaveof选项来开启复制功能。例如，现在有两台服务器——127.0.0.1:6379和127.0.0.1:7000，向服务器127.0.0.1:6379发送下面命令：

```bash
slaveof 127.0.0.1 7000
# ok
```

此时服务器127.0.0.1:6379会成为服务器127.0.0.1:7000的从服务器（slaver），服务器127.0.0.1:7000会成为服务器127.0.0.1:6379的主服务器（master）；通过复制功能，从服务器127.0.0.1:6379的数据可以和主服务器127.0.0.1:7000的数据保持同步。

## 主从复制功能实现

- 读写分离
- 数据容灾

slaveof 命令的主要流程
- 从服务器127.0.0.1:6379向主服务器127.0.0.1:7000发送sync命令，请求同步数据。
- 主服务器127.0.0.1:7000接收到sync命令请求，开始执行bgsave命令持久化数据到RDB文件，并且在持久化数据期间会将所有新执行的写入命令都保存到一个缓冲区。
- 当持久化数据执行完毕后，主服务器127.0.0.1:7000将该RDB文件发送给从服务器127.0.0.1:6379，从服务器接收该RDB文件，并将文件中的数据加载到内存。
- 主服务器127.0.0.1:7000将缓冲区中的命令请求发送给从服务器127.0.0.1:6379。
- 每当主服务器127.0.0.1:7000接收到写命令请求时，都会将该命令请求按照Redis协议格式发送给从服务器127.0.0.1:6379，从服务器接收并处理主服务器发送过来的命令请求。

主服务器和从服务器之间是通过TCP长连接交互数据的，假设某个时刻主从服务器之间的网络连接发生故障且时间比较短，在此期间主服务器只执行了很少的写命令请求。待主从服务器之间的网络连接恢复后，从服务器会重新连接到主服务器，并发送sync命令请求同步数据。这时候主服务器还需要执行持久化操作吗？显然是可以避免的，只要主服务器能够缓存连接故障期间执行的写命令即可。

Redis 2.8 提出了新的主从复制解决方案。从服务器会记录已经从主服务器接收到的数据量（复制偏移量）；而主服务器会维护一个复制缓冲区，记录自己已执行且待发送给从服务器的命令请求，同时还需要记录复制缓冲区第一个字节的复制偏移量。从服务器请求同步主服务器的命令也改为了psync。当从服务器连接到主服务器时，会向主服务器发送psync命令请求同步数据，同时告诉主服务器自己已经接收到的复制偏移量，主服务器判断该复制偏移量是否还包含在复制缓冲区；如果包含，则不需要执行持久化操作，直接向从服务器发送复制缓冲区中命令请求即可，这称为部分重同步；如果不包含，则需要执行持久化操作，同时将所有新执行的写命令缓存在复制缓冲区中，并重置复制缓冲区第一个字节的复制偏移量，这称为完整重同步。

每台Redis服务器都有一个运行ID，从服务器每次发送psync请求同步数据时，会携带自己需要同步主服务器的运行ID。主服务器接收到psync命令时，需要判断命令参数运行ID与自己的运行ID是否相等，只有相等才有可能执行部分重同步。而当从服务器首次请求主服务器同步数据时，从服务器显然是不知道主服务器的运行ID，此时运行ID以“?”填充，同时复制偏移量初始化为-1。

![主从复制初始化流程图](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658186686753-9.png)  

当主服务器判断可以执行部分重同步时向从服务器返回“+CON-TINUE”；需要执行完整重同步时向从服务器返回“+FULLRESYNC RUN_ID OFFSET”，其中RUN_ID为主服务器自己的运行ID, OFFSET为复制偏移量。

执行部分重同步的要求还是比较严格的
- RUN_ID 必须相等
- 复制偏移量必须包含在复制缓冲区中

在生产环境中, 经常会出现以下两种情况
- 从服务器重启(复制信息丢失)
- 主服务器故障导致主从切换(从多个从服务器重新选举出一台及其作为主服务器, 主服务器运行 ID 发生改变)

这时候显然是无法执行部分重同步的，而这两种情况又很常见，因此Redis 4.0针对主从复制又提出了两点优化，提出了psync2协议。

1. 持久化主从复制信息
Redis服务器关闭时，将主从复制信息（复制的主服务器RUN_ID与复制偏移量）作为辅助字段存储在RDB文件中；Redis服务器启动加载RDB文件时，恢复主从复制信息，重新同步主服务器时携带。

2. 存储上一个主服务器复制信息
初始化replid2为空字符串，second_replid_offset为-1；当主服务器发生故障，自己成为新的主服务器时，便使用replid2和second_replid_offset存储之前主服务器的运行ID与复制偏移量


## slaver 源码分析

1. 连接 socket
2. 发送 ping 请求包确认离开连接是否正确
3. 发起密码认证(如果需要)
4. 信息同步
5. 发送 psync 命令
6. 接受 RDB 文件并载入
7. 连接建立完成, 等待主服务器同步命令请求

## master 源码分析

<!-- 1. 连接 -->


