# 第二十二章 哨兵和集群

哨兵是 Redis 的高可用方案，可以在 Redis Maste r发生故障时自动选择一个 Redis Slave 切换为 Master，继续对外提供服务。集群提供数据自动分片到不同节点的功能，并且当部分节点失效后仍然可以使用。

## 哨兵

![哨兵部署方案](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658187265382-33.png)  

有一个Redis Master，该Master下有两个Slave。3个哨兵同时与Master和Slave建立连接，并且哨兵之间也互相建立了连接。

哨兵通过与Master和Slave的通信，能够清楚每个Redis服务的健康状态。这样，当Master发生故障时，哨兵能够知晓Master的此种情况，然后通过对Slave健康状态、优先级、同步数据状态等的综合判断，选取其中一个Slave切换为Master，并且修改其他Slave指向新的Master地址。

为什么实际中至少会部署3个以上哨兵并且哨兵数量最好是奇数呢？我们通过思考哨兵的作用来回答这个问题。哨兵是Redis的高可用机制，保证了Redis服务不出现单点故障。如果哨兵只部署一个，哨兵本身就成为了一个单点。那假如部署2个哨兵呢？当Redis的Master发生故障时，如果2个哨兵同时执行切换操作肯定不行，哨兵之间必须先约定好由谁来执行此次切换操作，此时就涉及了哨兵之间选leader的操作。假设2个哨兵各自投自己一票，根本选举不出leader。所以哨兵个数最好是奇数。

- 切换完成之后，客户端和其他哨兵如何知道现在提供服务的Redis Master是哪一个呢？
> 可以通过subscribe __sentinel__:hello频道，知道当前提供服务的Master的IP和Port。
- 假设执行切换的哨兵发生了故障，切换操作是否会由其他哨兵继续完成呢？
> 执行切换的哨兵发生故障后，剩余哨兵会重新选主，并且重新开始执行切换流程。
- 当故障Master恢复之后，会继续作为Master提供服务还是会作为一个Slave提供服务？
> Redis中主从切换完成之后，当故障Master恢复之后，会作为新Master的一个Slave来提供服务。

![单个哨兵连接示意图](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658187449956-26.png)  

哨兵启动之后会先与配置文件中监控的Master建立两条连接，一条称为命令连接，另一条称为消息连接。哨兵就是通过如上两条连接发现其他哨兵和Redis Slave服务器，并且与每个Redis Slave也建立同样的两条连接。

哨兵中每次执行 serverCron 时，都会调用 sentinelTimer() 函数。该函数会建立连接，并且定时发送心跳包并采集信息。该函数主要功能如下。
- 建立命令连接和消息连接。消息连接建立之后会订阅Redis服务的__sentinel__:hello频道。
- 在命令连接上每10s发送info命令进行信息采集；每1s在命令连接上发送ping命令探测存活性；每2s在命令连接上发布一条信息。
- 检测服务是否处于主观下线状态。
- 检测服务是否处于客观下线状态并且需要进行主从切换。

哨兵启动之后通过info命令进行信息采集，据此能够知道一个Redis Master有多少Slaves，然后在下一次执行sentinelTimer函数时会和所有的Slaves分别建立命令连接与消息连接。而通过订阅消息连接上的消息可以知道其他的哨兵。哨兵与哨兵之间只会建立一条命令连接，每1s发送一个ping命令进行存活性探测，每2s推送（publish）一条消息。

第3步中主观下线状态的探测针对所有的Master, Slave和哨兵。第4步中只会对Master服务器进行客观下线的判断。通过上文我们知道，如果有大于等于quorum个哨兵同时认为一台Master处于主观下线状态，才会将该Master标记为客观下线。那么，一个哨兵如何知道其他哨兵对一台Master服务器的判断状态呢？

Redis会向监控同一台Master的所有哨兵通过命令连接发送如下格式的命令

```bash
SENTINEL is-master-down-by-addr master_ip master_port current_epoch sentinel_runid 或者 *
```

其中最后一项当需要投票时发送sentinel_runid，否则发送一个*号。据此能够知道其他哨兵对该Master服务状态的判断，如果达到要求，就标记该Master为客观下线。

### 主从切换

![主从切换状态转换图](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658190921739-13.png)  

Redis 中选择规则
- 如果该Slave处于主观下线状态，则不能被选中。
- 如果该Slave 5s之内没有有效回复ping命令或者与主服务器断开时间过长，则不能被选中。
- 如果slave-priority为0，则不能被选中（slave-priority可以在配置文件中指定。正整数，值越小优先级越高，当指定为0时，不能被选为主服务器）。
- 在剩余Slave中比较优先级，优先级高的被选中；如果优先级相同，则有较大复制偏移量的被选中；否则按字母序选择排名靠前的Slave。

## 集群

![集群部署方式](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658191080574-4.png)  

有3个Redis Master，每个Redis Master挂载一个Redis Slave，共6个Redis实例。集群用来提供横向扩展能力，即当数据量增多之后，通过增加服务节点就可以扩展服务能力。背后理论思想是将数据通过某种算法分布到不同的服务节点，这样当节点越多，单台节点所需提供服务的数据就越少。

集群的相关问题

- 分槽（slot）：即如何决定某条数据应该由哪个节点提供服务
- 端如何向集群发起请求（客户端并不知道某个数据应该由哪个节点提供服务，并且如果扩容或者节点发生故障后，不应该影响客户端的访问）
- 某个节点发生故障之后，该节点服务的数据该如何处理
- 扩容，即向集群中添加新节点该如何操作
- 同一条命令需要处理的key分布在不同的节点中（如Redis中集合取并集、交集的相关命令），如何操作

### 集群简介

redis 将键空间分为了 16384 个 solt, 然后通过如下算法

```bash
HASH_SLOT = CRC16(key) mod 16384
```

计算出每个key所属的slot。客户端可以请求任意一个节点，每个节点中都会保存所有16384个slot对应到哪一个节点的信息。如果一个key所属的slot正好由被请求的节点提供服务，则直接处理并返回结果，否则返回MOVED重定向信息.

```bash
GET key -MOVED slot IP:PORT
```

由-MOVED开头，接着是该key计算出的slot，然后是该slot对应到的节点IP和Port。客户端应该处理该重定向信息，并且向拥有该key的节点发起请求。实际应用中，Redis客户端可以通过向集群请求slot和节点的映射关系并缓存，然后通过本地计算要操作的key所属的slot，查询映射关系，直接向正确的节点发起请求，这样可以获得几乎等价于单节点部署的性能。

当集群由于节点故障或者扩容导致重新分片后，客户端先通过重定向获取到数据，每次发生重定向后，客户端可以将新的映射关系进行缓存，下次仍然可以直接向正确的节点发起请求。

Redis集群中，客户端只能在主节点执行读写操作。如果需要在从节点中进行读操作，需要满足如下条件：
- 首先在客户端中执行readonly命令；
- 如果一个key所属的slot由主节点A提供服务，则请求该key时可以向A所属的从节点发起读请求。该请求不会被重定向。

当一个主节点发生故障后，其挂载的从节点会切换为主节点继续提供服务。

最后，当一条命令需要操作的key分属于不同的节点时，Redis会报错。Redis提供了一种称为hash tags的机制，由业务方保证当需要进行多个key的处理时，将所有key分布到同一个节点

主从切换
1. 自动切换
2. 手动切换

### 副本漂移

集群中共有6个实例，三主三从，每对主从只能有一个处于故障状态。假设一对主从同时发生故障，则集群中的某些slot会处于不能提供服务的状态，从而导致集群失效。

![集群副本漂移](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658191537964-37.png)  

![集群副本漂移](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-19/pic_1658191652960-22.png)  

### 分片漂移

有很多情况下需要进行分片的迁移，例如增加一个新节点之后需要把一些分片迁移到新节点，或者当删除一个节点之后，需要将该节点提供服务的分片迁移到其他节点，甚至有些时候需要根据负载重新配置分片的分布。

Redis集群中分片的迁移，即slot的迁移，需要将一个slot中所有的key从一个节点迁移到另一个节点。






