# TCC 分布式事务原理

## TCC 核心思想

TCC分布式事务最核心的思想就是在应用层将一个完整的事务操作分为三个阶段。在某种程度上讲，TCC是一种资源，实现了Try、Confirm、Cancel三个操作接口。与传统的两阶段提交协议不同的是，TCC是一种在应用层实现的两阶段提交协议，在TCC分布式事务中，对每个业务操作都会分为Try、Confirm和Cancel三个阶段，每个阶段所关注的重点不同.

![TCC 分布式事务每个阶段关注的重点](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657761852258-49.png)  

1. Try阶段
Try阶段是准备执行业务的阶段，在这个阶段尝试执行业务，重点关注如下事项。
1）完成所有的业务检查，确保数据的一致性。
2）预留必要的业务资源，确保数据的隔离性。
在下单扣减库存的业务场景中，如果使用了TCC分布式事务，则需要在Try阶段检查商品的库存数量是否大于或者等于下单提交的商品数量，如果商品的库存数量大于或者等于下单提交的商品数量，则标记扣减库存数量。此时的商品数量并没有真正扣减，只是做资源预留操作，并且会将订单信息保存到数据库，标记为待提交状态。如果商品的库存数量小于下单提交的商品数量，则提示用户库存不足，并且删除提交的订单数据或者将订单状态标记为删除

2. Confirm阶段
Confirm阶段是确认执行业务的阶段，在这个阶段确认执行的业务。此时，重点关注如下事项。
1）真正地执行业务。
2）不做任何业务逻辑检查，直接将数据持久化到数据库。
3）直接Try阶段预留的业务资源。
在下单扣减库存的业务场景中，由于在Try阶段已经检查过商品的库存数量大于或者等于下单提交的商品数量，因此在Confirm阶段不会进行二次检查，直接将订单的状态更新为“已提交”，并且真正执行扣减库存操作。在Confirm阶段是真正地执行业务操作，其间不会做任何业务检查，直接使用Try阶段预留的业务资源。

3. Cancel阶段
Cancel阶段取消执行业务，重点关注如下事项。
1）释放Try阶段预留的业务资源。
2）将数据库中的数据恢复到最初的状态。
在下单扣减库存的业务场景中，假设Try阶段检查的结果为商品的库存数量大于或者等于下单提交的商品数量，在执行完订单提交业务后，执行扣减库存操作时发生异常，或者在执行Confirm阶段的业务时发生异常。此时，会执行Cancel阶段的操作回滚业务，使数据回到提交订单之前的状态。

![TCC 分布式事务与关系型数据库事务操作对应关系](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657761950506-16.png)  

在一个分布式或微服务系统中，TCC分布式事务的Try阶段是先把多个应用中的业务资源锁定，预留执行分布式事务的资源。同样，关系型数据库的DML操作会锁定数据库的行记录，持有数据库的资源。TCC分布式事务的Confirm操作是在所有涉及分布式事务的应用的Try阶段都执行成功后确认并提交最终事务状态的操作，而关系型数据库的Commit操作是在所有的DML操作执行成功之后提交事务。TCC分布式事务的Cancel操作是在涉及分布式事务的应用没有全部执行成功时，将已经执行成功的应用进行回滚，而关系型数据库的回滚操作是在执行的DML操作存在异常时执行的。关系型数据库中的Commit操作和Rollback操作也是一对反向业务操作，TCC分布式事务中的Confirm操作和Cancel操作也是一对反向业务操作。

另外，由于使用TCC分布式事务时，各业务系统的事务未达到最终状态时，会存在短暂的数据不一致现象，因此各业务系统需要具备兼容数据最终一致性之前带来的可见性问题的能力。

## TCC 实现原理

![TCC 分布式事务包含的核心部分](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762024505-18.png)  

主业务服务是TCC分布式事务的发起方，在下单扣减库存的业务场景中，订单服务是TCC分布式事务的发起方，就是主业务服务。
从业务服务主要负责提供TCC业务操作，是整个业务活动的操作方。从业务活动必须实现TCC分布式事务Try、Confirm和Cancel三个阶段的接口，供主业务服务调用。由于在TCC分布式事务的执行过程中，Confirm阶段的操作和Cancel阶段的操作可能会被执行多次，因此需要Confirm阶段的操作和Cancel阶段的操作保证幂等性。
TCC管理器在整个TCC分布式事务的执行过程中，管理并控制着整个事务活动，包括记录并维护TCC全局事务的事务状态和每个从业务服务的分支事务状态，并在参与分布式事务的所有分支事务的Try阶段都执行成功时，自动调用每个分支事务的Confirm阶段的操作，完成分布式事务，同时会在参与分布式事务的某些分支事务执行失败时，自动调用分支事务的Cancel操作回滚分布式事务。

### TCC 核心原理

在使用TCC分布式事务解决分布式场景下的数据一致性问题时，需要将原本的一个事务接口改造成三个不同的事务逻辑，也就是前文说的Try阶段、Confirm阶段和Cancel阶段。
原本一个接口的方法完成的事务逻辑也要分拆成如下执行流程。
1）依次执行所有参与TCC分布式事务的分支事务Try阶段的操作。
2）如果每个分支事务Try阶段的逻辑都执行成功，则TCC分布式事务管理器会自动调用每个分支事务Confirm阶段的方法并执行，完成整个分布式事务的逻辑。
3）如果某个分支事务的Try逻辑或者Confirm逻辑的执行出现问题，则TCC分布式事务管理器会自动感知这些异常信息，然后自动调用每个分支事务Cancel阶段的方法执行Cancel逻辑，回滚之前执行的各种操作，使数据恢复到执行TCC分布式事务之前的状态。
讲得直白点，就是如果遇到如下情况，TCC分布式事务会在Try阶段检查参与分布式事务的各个服务、数据库和资源是否都能够保证分布式事务正常执行，能否将执行分布式事务的资源预留出来，而不是先执行业务逻辑操作。
1）数据库或其他数据存储服务宕机，例如下单扣减库存时，库存数据库宕机了。
2）某个应用服务宕机，例如下单扣减库存时，库存服务宕机了。
3）参与分布式事务的资源不足，例如下单扣减库存时，商品库存不足。
如果参与分布式事务的服务都正常执行了，也就是说，数据库或其他数据存储能够正常提供服务，所有参与分布式事务的应用服务正常，执行分布式事务时需要的资源充足，并且在Try阶段顺利预留出执行分布式事务需要的资源，再执行TCC分布式事务的Confirm阶段，就能够大概率保证分布式事务成功执行。

如果在Try阶段，某个服务执行失败了，可能是数据库或者其他数据存储宕机了，或者是这个服务宕机了，也有可能是这个服务对应的数据资源不足。此时，会自动执行各个服务Cancel阶段的逻辑，回滚Try阶段执行的业务逻辑，将数据恢复到执行分布式事务之前的状态。
其实，通过上面的逻辑，TCC分布式事务还是不能保证执行结果数据的一致性。这里存在着一个问题，那就是如果发生了异常情况，例如，在下单扣减库存的业务场景中，订单服务突然宕机，然后重启订单服务，TCC分布式事务如何保证之前没有执行完的事务继续执行呢？
这种问题在实际的业务场景中是经常出现的，在设计TCC分布式事务框架时必须要考虑这种异常场景。在执行TCC分布式事务时，需要记录一些分布式事务的活动日志，将这些活动日志存储到文件或者数据库中，将分布式事务的各个阶段和每个阶段执行的状态全部记录下来。
除了参与TCC分布式事务的某些服务宕机这种问题，还需要注意空回滚、幂等和悬挂等问题。有关空回滚、幂等和悬挂问题及解决方案. 

![TCC 分布式事务总体执行示意图](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762107645-31.png)  

无论是主业务服务还是从业务服务，在执行TCC分布式事务时，都需要TCC事务管理器的参与。在实际业务场景中，TCC事务管理器作为某一种具体的TCC分布式事务框架，例如Dromara开源社区的Hmily框架，会在Try阶段进行业务检查、预留业务资源。在Confirm阶段不再进行业务检查，使用Try阶段预留的业务资源真正地执行业务操作。在Cancel阶段释放Try阶段预留的资源，使数据回滚到执行TCC分布式事务之前的状态。在TCC分布式事务的每个阶段，TCC事务管理器都会将各个阶段和每个阶段执行的状态全部记录到事务记录数据库或者事务记录文件中。

## TCC 核心流程

业务场景介绍

在电商业务场景中，一个典型的业务场景就是支付订单。这个场景包含修改订单状态、扣减存库、增加积分、创建出库单等业务，这些业务要么全部执行成功，要么全部执行失败，必须是一个完整的事务。如果不能构成一个完整的事务，就有可能出现库存未扣减或者超卖的问题。

如果没有使用分布式事务，在订单服务中，修改订单状态成功，调用远程的库存服务出现异常，此时有可能出现修改订单成功，但库存未扣减的情况.

![支付场景修改订单成功但库存未扣减](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762470189-28.png)  

如果库存服务出现异常，则订单服务在第②步调用库存服务执行扣减库存的操作就失败了，随后调用积分服务增加积分和调用存储服务生成出库单却都成功了，此时就出现了支付修改订单状态成功，商品库存未扣减的情况。

如果修改订单状态的操作执行失败，而调用库存服务扣减商品库存的操作执行成功，此时就出现了商品库存被异常扣减的情况，可能会导致超卖的现象.

![支付场景更新订单状态失败而库存却扣减成功](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762517980-17.png)  

在支付订单的场景中，第①步更新订单操作失败，但是后续调用库存服务、积分服务和仓储服务都执行成功，这种情况可能就是用户支付失败，或者取消了支付，但是仍旧扣减了库存、增加了用户积分、提交了出库单，最终可能会导致商品超卖的严重问题。

### try 阶段流程

在电商支付订单的业务场景中，为了保证最终数据的一致性，对于订单服务，不能将订单状态直接更新为“支付成功”，而是要先更新为“支付中”的状态；对于库存服务，也不能直接扣减库存，而是要扣减库存后在冻结库存的字段中保存扣减库存的数量；对于积分服务，不能直接为用户账户增加积分，而是要在单独的字段中设置用户应该增加的积分；对于仓储服务，创建的出库单状态应该被标记为“不确定”，如图9-7所示。
在电商支付订单的场景中，Try阶段主要的业务流程如下所示。
1）订单服务将订单数据库中订单的状态更新为“支付中”。
2）订单服务调用库存服务冻结部分库存，将冻结的库存数量也就是用户下单时提交的商品数量，单独写入商品库存表的冻结字段中，同时将商品库存数量减去冻结的商品数量。
3）订单服务调用积分服务进行预增加积分的操作，在用户积分数据表中，将要增加的积分写入单独的预增加积分字段中，而不是直接增加用户的积分。
4）订单服务调用仓储服务生成出库单时，将出库单的状态标记为“未知”，并不直接生成正常的出库单。

![电商支付场景中 try 阶段执行的流程](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762580632-3.png)  

### confirm 阶段

如果Try阶段的业务逻辑全部执行成功，则TCC分布式事务会执行Confirm阶段的业务逻辑。在实际场景中，Confirm阶段的执行往往是由TCC分布式事务框架调用完成的。在订单服务中会将订单的状态由“支付中”更新为“支付成功”。在库存服务中会真正地扣减库存，将写入冻结字段的库存数量减去当次下单时提交的商品数量。在积分服务中会将当次支付产生的积分从预增加积分字段中扣除，并将对应的积分增加到用户积分账户中。在仓储服务中会将出库单的状态由“未知”更新为“已创建”.

![电商支付场景中 confirm 阶段执行的流程](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762643548-17.png)  

在电商支付订单的场景中，Confirm阶段主要的业务流程如下所示。
1）订单服务将订单数据库中订单的状态更新为“支付成功”。
2）TCC分布式事务框架调用库存服务中Confirm阶段的方法，真正地扣减库存，将预扣减字段中的库存数量减去当次下单提交的商品数量。
3）TCC分布式事务框架调用积分服务中Confirm阶段的方法，真正地增加积分，将预增加积分字段中的积分数量减去当次支付产生的积分数量，并且在用户的积分账户中增加当次支付产生的积分数量。
4）TCC分布式事务框架调用仓储服务中Confirm阶段的方法，将出库单的状态更新为“已创建”。

### cancel 阶段

如果Try阶段的业务执行失败，或者某个服务出现异常等，TCC分布式事务框架能够感知到这些异常信息，会自动执行Cancel阶段的流程，对整个TCC分布式事务进行回滚。在实际场景中，Cancel阶段的执行往往是由TCC分布式事务框架调用完成的。

在订单服务中，将订单的状态更新为“已取消”。在库存服务中，将当次下单提交的商品数量加回到商品库存字段中，并且在预扣减库存的字段中减去当次下单提交的商品数量。在积分服务中，在预增加积分字段中减去当次支付产生的积分数量。在仓储服务中，将出库单的状态标记为“已取消”。

![电商支付场景中 cancel 阶段执行流程](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-14/pic_1657762723213-43.png)  

在电商支付订单的场景中，Cancel阶段主要的业务流程如下所示。
1）订单服务将订单数据库中订单的状态标记为“已取消”。
2）TCC分布式事务框架调用库存服务Cancel阶段的方法进行事务回滚，将库存数据表中的预扣减库存字段中存储的商品数量减去当次下单提交的商品数量，并且将库存数据表中的商品库存字段存储的商品库存数量增加当次下单提交的商品数量。
3）TCC分布式事务框架调用积分服务Cancel阶段的方法进行事务回滚，将积分数据中的预增加积分字段中的积分数量减去当次支付产生的积分数量。
4）TCC分布式事务框架调用仓储服务Cancel阶段的方法进行事务回滚，将出库单的状态标记为“已取消”。

## 关键技术
TCC 分布式事务框架 Hmily 为例

- AOP
- 反射
- 持久化技术
- 序列化技术
- 定时任务
- 动态代理
- 多配置源技术









