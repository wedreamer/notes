# 第二章 mysql 事务的是实现原理

## mysql 中的 XA 事务

mysql 5.0.3 版本开始支持 XA 分布式事务, 并且只有 innodb 支持 XA 事务.

### XA 事务的基本原理

XA 事务支持不同数据库之间实现分布式事务。这里的不同数据库，可以是不同的 MySQL 实例，也可以是不同的数据库类型，比如 MySQL 数据库和 Oracle 数据库。
XA 事务本质上是一种基于两阶段提交的分布式事务，分布式事务可以简单理解为多个数据库事务共同完成一个原子性的事务操作。参与操作的多个事务要么全部提交成功，要么全部提交失败。在使用 XA 分布式事务时，InnoDB 存储引擎的事务隔离级别需要设置为串行化。
XA 事务由一个事务管理器（Transaction Manager）, 一个或者多个资源管理器（ResourceManager）和一个应用程序（Application Program）组成, 组成模型如图所示。

![XA 事务模型](https://shubuzuo.coding.net/p/image-host/d/image-host/git/raw/master/images/2022-07/2022-07-13/pic_1657698058028-44.png)  

事务管理器：主要对参与全局事务的各个分支事务进行协调，并与资源管理器进行通信。
资源管理器：主要提供对对事务资源的访问能力。实际上，一个数据库就可以看作一个资源管理器。
应用程序：主要用来明确全局事务和各个分支事务，指定全局事务中的各个操作

因为 XA 事务是基于两阶段提交的分布式事务，所以 XA 事务也被拆分为 Prepare 阶段和 Commit 阶段。

在 Prepare 阶段，事务管理器向资源管理器发送准备指令，资源管理器接收到指令后，执行数据的修改操作并记录相关的日志信息，然后向事务管理器返回可以提交或者不可以提交的结果信息。
在 Commit 阶段，事务管理器接收所有资源管理器返回的结果信息，如果某一个或多个资源管理器向事务管理器返回的结果信息为不可以提交，或者超时，则事务管理器向所有的资源管理器发送回滚指令。如果事务管理器收到的所有资源管理器返回的结果信息为可以提交，则事务管理器向所有的资源管理器发送提交事务的指令。
